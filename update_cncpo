#!/bin/bash

URL_cncpo='https://212.14.145.50/'
FILE_cncpo='tmp/blacklist.csv'
NOC_EMAIL='noc@connesi.it'
FROM_EMAIL='cncpo@connesi.it'

CERTS_cncpo='--cert cncpo.pem --key cncpo.key --cacert cncpo-ca.pem --ciphers DES-CBC3-SHA'

CURL_OPTS_cncpo="$CERTS_cncpo"

source curl_errors.sh

##############################################################################
# be verbose when stdout is a tty
if [ ! -t 0 ]; then
  CURL_OPTS_cncpo="$CURL_OPTS_cncpo --silent --show-error"
fi

# on this server, bind to a specific IP address
if [ "$(hostname --fqdn)" = "anubi.seeweb.it" ]; then
  CURL_OPTS_cncpo="$CURL_OPTS_cncpo --interface 212.25.179.125"
fi

## downloading ###############################################################
curl --fail --location --remote-time $CURL_OPTS_cncpo \
  --output $FILE_cncpo.tmp $URL_cncpo
CURL_RETURN=$?

mv $FILE_cncpo.tmp $FILE_cncpo

if [ $CURL_RETURN != 0 ] ; then
        SUBJECT="Error while fetching CNCPO lists"
        TXT="Curl on $(hostname -f) have returned $CURL_RETURN:\n\n${curl_errors[$CURL_RETURN]}\n\n when trying to get $URL_cncpo."
        echo -e "Subject: $SUBJECT\nFrom:$FROM_EMAIL\n$TXT" | sendmail $NOC_EMAIL
        echo "Warning: $TXT"

fi

## parsing ###################################################################
./parse_cncpo $FILE_cncpo lists/cncpo.new lists/cncpo-ip.new

